<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="jakarta.faces.html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:f="jakarta.faces.core">
<h:head>
    <meta charset="UTF-8"/>
    <h:outputStylesheet library="estilos" name="disenoAlmacen.css"/>
    <title>#{msg['despacho.titulo']}</title>
    <style>
        /* Estilos para el diálogo Kardex mejorado */
        .kardex-dialog .ui-dialog-titlebar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
        }

        .kardex-container {
            background: #f8f9fa;
            padding: 15px;
        }

        .kardex-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }

        .kardex-field {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid #667eea;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .kardex-field-full {
            grid-column: 1 / -1;
        }

        .kardex-label {
            display: block;
            font-size: 0.75em;
            font-weight: 600;
            color: #495057;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .kardex-value {
            font-size: 0.95em;
            color: #212529;
            font-weight: 500;
        }

        .kardex-tipo-movimiento {
            background: #ffe5e5;
            padding: 4px 10px;
            border-radius: 4px;
            display: inline-block;
            font-weight: 600;
            color: #c92a2a;
        }

        .kardex-input .ui-inputtext,
        .kardex-input .ui-selectonemenu {
            width: 100%;
            border: 2px solid #e9ecef;
            border-radius: 4px;
            padding: 6px 10px;
            font-size: 0.9em;
        }

        .kardex-input .ui-inputtext:focus,
        .kardex-input .ui-selectonemenu:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .kardex-required {
            color: #dc3545;
            font-weight: bold;
        }

        .kardex-footer {
            background: white;
            padding: 12px 15px;
            border-top: 2px solid #e9ecef;
            text-align: center;
            border-radius: 0 0 8px 8px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .kardex-btn-primary {
            background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
            border: none;
            padding: 8px 20px;
            border-radius: 4px;
            font-weight: 600;
            color: white;
            box-shadow: 0 2px 8px rgba(55, 178, 77, 0.3);
        }

        .kardex-btn-primary:hover {
            background: linear-gradient(135deg, #40c057 0%, #2f9e44 100%);
            box-shadow: 0 4px 12px rgba(55, 178, 77, 0.4);
        }

        .kardex-btn-secondary {
            background: #6c757d;
            border: none;
            padding: 8px 20px;
            border-radius: 4px;
            font-weight: 600;
            color: white;
        }

        .kardex-btn-secondary:hover {
            background: #5a6268;
        }
    </style>
</h:head>
<h:body>
    <!-- Traductor -->
    <ui:include src="/paginas/ues/BotonesTop.xhtml">
        <ui:param name="section" value="traductor"/>
    </ui:include>

    <div class="page-container">
        <!-- Sidebar -->
        <ui:include src="/paginas/ues/Sidebar.xhtml"/>

        <div class="container">
            <div class="header">
                <h1>#{msg['despacho.titulo']}</h1>
            </div>

            <div class="content">
                <!-- ========== TABLA PRINCIPAL DE VENTAS ========== -->
                <h:panelGroup id="pnlTabla" layout="block"
                              style="display:#{despachoFrm.estado eq 'NADA' ? 'block' : 'none'}">
                    <div class="content-tabla">
                        <h:form id="frmTabla">
                            <p:dataTable id="tabla"
                                         lazy="true"
                                         rendered="#{despachoFrm.estado == 'NADA'}"
                                         rows="5"
                                         paginator="true"
                                         paginatorPosition="bottom"
                                         value="#{despachoFrm.modelo}"
                                         var="reg"
                                         selectionMode="single"
                                         selection="#{despachoFrm.registro}"
                                         rowKey="#{reg.id}">
                                <p:ajax event="rowSelect"
                                        listener="#{despachoFrm.selectionHandler}"
                                        update=":pnlTabla :pnlDetalle :messagesTabla"/>

                                <p:column headerText="#{msg['tabla.id']}">
                                    <h:outputText value="#{reg.id}"/>
                                </p:column>

                                <p:column headerText="#{msg['cliente.titulo']}">
                                    <h:outputText value="#{reg.idCliente.nombre}"/>
                                </p:column>

                                <p:column headerText="#{msg['tabla.fecha']}">
                                    <h:outputText value="#{reg.fecha}">
                                        <f:convertDateTime type="offsetDateTime" pattern="dd/MM/yyyy HH:mm:ss"/>
                                    </h:outputText>
                                </p:column>

                                <p:column headerText="#{msg['tabla.estado']}">
                                    <h:outputText value="#{reg.estado}"/>
                                </p:column>

                                <p:column headerText="#{msg['tabla.observaciones']}">
                                    <h:outputText value="#{reg.observaciones}"/>
                                </p:column>

                                <p:column headerText="#{msg['montoTotal.titulo']}">
                                    <h:outputText value="$ #{ventaFrm.getTotalVenta(reg)}"/>
                                </p:column>
                            </p:dataTable>
                        </h:form>

                        <p:growl id="messagesTabla" showDetail="true" life="5000" sticky="false"/>
                    </div>
                </h:panelGroup>

                <!-- ========== DETALLE DE LA VENTA ========== -->
                <h:panelGroup id="pnlDetalle">
                    <p:tabView id="tabDespacho" cache="false" dynamic="true"
                               rendered="#{despachoFrm.estado != 'NADA'}">

                        <!-- TAB: Generalidades -->
                        <p:tab closable="false" title="#{msg['tab.generalidades']}">
                            <h:form id="frmGeneral">
                                <h3>Seleccione las ventas que despachará en detalles de venta.</h3>

                                <h:panelGrid columns="2" cellpadding="5" style="width: 100%;">
                                    <h:outputLabel value="#{msg['form.id']}:"/>
                                    <h:outputText value="#{despachoFrm.registro.id}"/>

                                    <h:outputLabel value="#{msg['tabla.proveedor']}:"/>
                                    <h:outputText value="#{despachoFrm.registro.idCliente.nombre}"/>

                                    <h:outputLabel value="#{msg['tabla.fecha']}:"/>
                                    <h:outputText value="#{despachoFrm.registro.fecha}">
                                        <f:convertDateTime type="offsetDateTime" pattern="dd/MM/yyyy HH:mm:ss"/>
                                    </h:outputText>

                                    <h:outputLabel value="#{msg['tabla.estado']}:"/>
                                    <h:outputText value="#{despachoFrm.registro.estado}"/>

                                    <h:outputLabel value="#{msg['tabla.observaciones']}:"/>
                                    <h:outputText value="#{despachoFrm.registro.observaciones}"/>
                                </h:panelGrid>
                            </h:form>

                            <!-- Botón Cancelar en su propio form -->
                            <h:form id="frmCancelarGeneral">
                                <h:panelGrid columns="1" style="margin-top: 15px;">
                                    <ui:include src="/paginas/ues/BotonesTop.xhtml">
                                        <ui:param name="section" value="cancelar"/>
                                        <ui:param name="bean" value="#{despachoFrm}"/>
                                    </ui:include>
                                </h:panelGrid>
                            </h:form>
                        </p:tab>

                        <!-- TAB: Detalles de Venta -->
                        <p:tab closable="false"
                               title="#{msg['tab.ventaDetalle']}"
                               disabled="#{despachoFrm.estado eq 'CREAR'}">
                            <h:panelGroup id="pnlVentaDetalles">
                                <h2>Detalles de esta venta #{despachoFrm.registro.id}</h2>

                                <!-- TABLA DE DETALLES -->
                                <h:form id="frmTablaDetalles">
                                    <p:dataTable id="tablaDetalles"
                                                 lazy="true"
                                                 rendered="#{despachoFrm.ventaDetalleFrm.estado == 'NADA'}"
                                                 rows="5"
                                                 paginator="true"
                                                 paginatorPosition="bottom"
                                                 value="#{despachoFrm.ventaDetalleFrm.modelo}"
                                                 var="tp"
                                                 selectionMode="single"
                                                 selection="#{despachoFrm.ventaDetalleFrm.registro}"
                                                 rowKey="#{tp.id}">
                                        <p:ajax event="rowSelect"
                                                listener="#{despachoFrm.ventaDetalleFrm.selectionHandler}"
                                                update="tabDespacho:pnlVentaDetalles tabDespacho:pnlProductoDetalle :messagesDetalles"/>

                                        <p:column headerText="#{msg['tabla.id']}">
                                            <h:outputText value="#{tp.id}"/>
                                        </p:column>

                                        <p:column headerText="#{msg['producto.titulo']}">
                                            <h:outputText value="#{tp.idProducto.nombreProducto}"/>
                                        </p:column>

                                        <p:column headerText="#{msg['tabla.cantidad']}">
                                            <h:outputText value="#{tp.cantidad}"/>
                                        </p:column>

                                        <p:column headerText="#{msg['tabla.precioUnitario']}">
                                            <h:outputText value="#{tp.precio}"/>
                                        </p:column>

                                        <p:column headerText="#{msg['form.estado']}">
                                            <h:outputText value="#{tp.estado}"
                                                          styleClass="#{tp.estado eq 'DESPACHADO' ? 'estado-despachado' : 'estado-pendiente'}"/>
                                        </p:column>

                                        <p:column headerText="#{msg['form.observaciones']}">
                                            <h:outputText value="#{tp.observaciones}"/>
                                        </p:column>
                                    </p:dataTable>

                                    <p:growl id="messagesDetalles" showDetail="true" life="5000" sticky="false"/>
                                </h:form>
                            </h:panelGroup>

                            <!-- DETALLE DEL PRODUCTO SELECCIONADO -->
                            <h:panelGroup id="pnlProductoDetalle">
                                <h:form id="frmDetalleProducto"
                                        rendered="#{despachoFrm.ventaDetalleFrm.estado != 'NADA'}">
                                    <h:panelGrid columns="2" cellpadding="5" style="width: 100%;">
                                        <h:outputLabel value="#{msg['form.id']}:"/>
                                        <h:outputText value="#{despachoFrm.ventaDetalleFrm.registro.id}"/>

                                        <h:outputLabel value="#{msg['producto.titulo']}:"/>
                                        <h:outputText value="#{despachoFrm.ventaDetalleFrm.registro.idProducto.nombreProducto}"/>

                                        <h:outputLabel value="#{msg['tabla.cantidad']}:"/>
                                        <h:outputText value="#{despachoFrm.ventaDetalleFrm.registro.cantidad}">
                                            <f:convertNumber type="number" minFractionDigits="2" maxFractionDigits="2"/>
                                        </h:outputText>

                                        <h:outputLabel value="#{msg['tabla.precioUnitario']}:"/>
                                        <h:outputText value="#{despachoFrm.ventaDetalleFrm.registro.precio}"/>

                                        <h:outputLabel value="#{msg['form.estado']}:"/>
                                        <h:outputText value="#{despachoFrm.ventaDetalleFrm.registro.estado}"/>

                                        <h:outputLabel value="#{msg['form.observaciones']}:"/>
                                        <h:outputText value="#{despachoFrm.ventaDetalleFrm.registro.observaciones}"/>
                                    </h:panelGrid>

                                    <!-- Botones de Acción -->
                                    <h:panelGrid columns="1" style="margin-top: 15px;">
                                        <h:panelGroup>
                                            <p:commandButton value="Despachar"
                                                             icon="pi pi-check"
                                                             styleClass="ui-button-success"
                                                             action="#{despachoFrm.despachoKardexFrm.prepararKardex(despachoFrm.ventaDetalleFrm.registro)}"
                                                             update=":dlgKardex"
                                                             oncomplete="PF('dlgKardex').show()"
                                                             rendered="#{despachoFrm.ventaDetalleFrm.registro.estado ne 'DESPACHADO'}"/>

                                            <h:outputText value="✓ Despachado"
                                                          rendered="#{despachoFrm.ventaDetalleFrm.registro.estado eq 'DESPACHADO'}"
                                                          style="color: #4caf50; font-weight: bold; margin-left: 10px;"/>
                                        </h:panelGroup>
                                    </h:panelGrid>
                                </h:form>

                                <!-- Botón Cancelar en su propio form -->
                                <h:form id="frmCancelarDetalle">
                                    <h:panelGrid columns="1" style="margin-top: 10px;">
                                        <ui:include src="/paginas/ues/BotonesTop.xhtml">
                                            <ui:param name="section" value="cancelar"/>
                                            <ui:param name="bean" value="#{despachoFrm.ventaDetalleFrm}"/>
                                        </ui:include>
                                    </h:panelGrid>
                                </h:form>
                            </h:panelGroup>
                        </p:tab>
                    </p:tabView>
                </h:panelGroup>
            </div>
        </div>
    </div>

    <!-- ========== DIÁLOGO KARDEX REDISEÑADO ========== -->
    <p:dialog header="Despachar Producto en Bodega"
              id="dlgKardex"
              widgetVar="dlgKardex"
              modal="true"
              width="700"
              showEffect="fade"
              closeOnEscape="true"
              resetValues="true"
              styleClass="kardex-dialog">
        <h:form id="frmKardex">
            <div class="kardex-container">
                <!-- Grid de 2 columnas -->
                <div class="kardex-grid">
                    <!-- Producto -->
                    <div class="kardex-field kardex-field-full">
                        <span class="kardex-label">Producto</span>
                        <h:outputText value="#{despachoFrm.despachoKardexFrm.registro.idProducto.nombreProducto}"
                                      styleClass="kardex-value"/>
                    </div>

                    <!-- Cantidad -->
                    <div class="kardex-field">
                        <span class="kardex-label">Cantidad</span>
                        <h:outputText value="#{despachoFrm.despachoKardexFrm.registro.cantidad}"
                                      styleClass="kardex-value">
                            <f:convertNumber pattern="#,##0.00"/>
                        </h:outputText>
                    </div>

                    <!-- Precio -->
                    <div class="kardex-field">
                        <span class="kardex-label">Precio</span>
                        <h:outputText value="$ #{despachoFrm.despachoKardexFrm.registro.precio}"
                                      styleClass="kardex-value">
                            <f:convertNumber pattern="#,##0.00"/>
                        </h:outputText>
                    </div>

                    <!-- Fecha -->
                    <div class="kardex-field">
                        <span class="kardex-label">Fecha de Recepción</span>
                        <h:outputText value="#{despachoFrm.despachoKardexFrm.registro.fecha}"
                                      styleClass="kardex-value">
                            <f:convertDateTime type="offsetDateTime" pattern="dd/MM/yyyy HH:mm:ss"/>
                        </h:outputText>
                    </div>

                    <!-- Tipo Movimiento -->
                    <div class="kardex-field">
                        <span class="kardex-label">Tipo Movimiento</span>
                        <h:outputText value="#{despachoFrm.despachoKardexFrm.registro.tipoMovimiento}"
                                      styleClass="kardex-tipo-movimiento"/>
                    </div>

                    <!-- Referencia Externa -->
                    <div class="kardex-field kardex-field-full kardex-input">
                        <span class="kardex-label">Referencia Externa</span>
                        <p:inputText id="txtRefExterna"
                                     value="#{despachoFrm.despachoKardexFrm.registro.referenciaExterna}"/>
                    </div>

                    <!-- Observaciones -->
                    <div class="kardex-field kardex-field-full kardex-input">
                        <span class="kardex-label">Observaciones</span>
                        <p:inputTextarea id="txtObsKardex"
                                         value="#{despachoFrm.despachoKardexFrm.registro.observaciones}"
                                         rows="2"
                                         style="width: 100%;"/>
                    </div>

                    <!-- Lote -->
                    <div class="kardex-field kardex-input">
                        <span class="kardex-label">Lote</span>
                        <p:inputText id="txtLote"
                                     value="#{despachoFrm.despachoKardexFrm.detalleKardex.lote}"/>
                    </div>

                    <!-- Almacén -->
                    <div class="kardex-field kardex-input">
                        <span class="kardex-label kardex-required">Almacén *</span>
                        <p:selectOneMenu id="cbAlmacenKardex"
                                         value="#{despachoFrm.despachoKardexFrm.registro.idAlmacen}"
                                         converter="almacenConverter"
                                         required="true"
                                         requiredMessage="Debe seleccionar un almacén">
                            <f:selectItem itemLabel="-- Seleccione almacén --" itemValue="#{null}"/>
                            <f:selectItems value="#{despachoFrm.despachoKardexFrm.listaAlmacenes}"
                                           var="alm"
                                           itemLabel="#{alm.observaciones}"
                                           itemValue="#{alm}"/>
                        </p:selectOneMenu>
                    </div>
                </div>
            </div>

            <!-- Footer con botones -->
            <div class="kardex-footer">
                <p:commandButton value="Despachar Producto"
                                 icon="pi pi-check-circle"
                                 styleClass="kardex-btn-primary"
                                 actionListener="#{despachoFrm.despachoKardexFrm.btnRecibirHandler}"
                                 update=":messagesGlobal tabDespacho:pnlVentaDetalles tabDespacho:pnlProductoDetalle :pnlTabla"
                                 oncomplete="if(!args.validationFailed) PF('dlgKardex').hide()"/>

                <p:commandButton value="Cancelar"
                                 icon="pi pi-times-circle"
                                 styleClass="kardex-btn-secondary"
                                 type="button"
                                 onclick="PF('dlgKardex').hide();"/>
            </div>
        </h:form>
    </p:dialog>

    <p:growl id="messagesGlobal" showDetail="true" life="5000" sticky="false" autoUpdate="true"/>

    <script type="text/javascript">
        //<![CDATA[
        (function() {
            let ws;

            function conectar() {
                ws = new WebSocket("ws://localhost:9080/JPQL2-1.0-SNAPSHOT/notificadorKardex");

                ws.onmessage = function(event) {
                    if (event.data === "RELOAD_TABLE") {
                        console.log("Recargando tabla...");

                        if (typeof PF !== 'undefined') {
                            PrimeFaces.ajax.Request.handle({
                                source: 'frmTabla:tabla',
                                process: '@this',
                                update: 'frmTabla:tabla',
                                oncomplete: function(xhr, status, args) {
                                    console.log("Tabla actualizada exitosamente");
                                }
                            });
                        } else {
                            console.warn("PrimeFaces no disponible, recargando página completa");
                            location.reload();
                        }
                    }
                };

                ws.onopen = function() {
                    console.log("WebSocket conectado en página de Despacho");
                };

                ws.onerror = function(error) {
                    console.error("Error en WebSocket:", error);
                };

                ws.onclose = function() {
                    console.log("WebSocket desconectado. Reconectando en 3 segundos...");
                    setTimeout(conectar, 3000);
                };
            }

            window.addEventListener('load', conectar);
        })();
        //]]>
    </script>

</h:body>
</html>