<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="jakarta.faces.html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:f="jakarta.faces.core">

<h:head>
    <meta charset="UTF-8"/>
    <h:outputStylesheet library="estilos" name="disenoAlmacen.css"/>
    <title>#{msg['venta.titulo.principal']}</title>
</h:head>

<h:body>
    <f:event type="preRenderView" listener="#{ventaFrm.inicializar}"/>

    <div class="page-container">
        <ui:include src="/paginas/ues/Sidebar.xhtml"/>
        <div class="container">
            <div class="header">
                <h1>#{msg['venta.titulo.principal']}</h1>
            </div>

            <div class="content">
                <!-- PANEL TABLA -->
                <h:panelGroup id="pnlTabla" layout="block"
                              style="display:#{ventaFrm.estado eq 'NADA' ? 'block' : 'none'}">
                    <div class="content-tabla">
                        <h:form id="frmTabla">
                            <p:dataTable id="tblVentas"
                                         lazy="true"
                                         rendered="#{ventaFrm.estado == 'NADA'}"
                                         rows="#{ventaFrm.pageSize}"
                                         paginator="true"
                                         paginatorPosition="bottom"
                                         value="#{ventaFrm.modelo}"
                                         var="item"
                                         selectionMode="single"
                                         selection="#{ventaFrm.registro}"
                                         rowKey="#{item.id}">

                                <p:ajax event="rowSelect"
                                        listener="#{ventaFrm.selectionHandler}"
                                        update=":pnlTabla :pnlDetalle :messages"/>

                                <p:column headerText="#{msg['tabla.venta.columna.id']}" width="200">
                                    <h:outputText value="#{item.id}"/>
                                </p:column>

                                <p:column headerText="#{msg['tabla.venta.columna.cliente']}">
                                    <h:outputText value="#{item.idCliente.nombre}"/>
                                </p:column>

                                <p:column headerText="#{msg['tabla.venta.columna.fecha']}">
                                    <h:outputText value="#{item.fecha}">
                                        <f:converter converterId="offsetDateTimeConverter"/>
                                    </h:outputText>
                                </p:column>

                                <p:column headerText="#{msg['tabla.venta.columna.estado']}" width="120">
                                    <h:outputText value="#{item.estado}"/>
                                </p:column>

                                <p:column headerText="#{msg['tabla.venta.columna.observaciones']}" width="200">
                                    <h:outputText value="#{item.observaciones}"/>
                                </p:column>
                            </p:dataTable>

                            <!-- BOTÓN NUEVO -->
                            <p:commandButton id="btnNuevo"
                                             value="#{msg['boton.nuevo']}"
                                             rendered="#{ventaFrm.estado == 'NADA' or ventaFrm.estado.name() == 'NADA'}"
                                             styleClass="btn-nuevo"
                                             actionListener="#{ventaFrm.btnNuevoHandler}"
                                             process="@this"
                                             update=":pnlDetalle :pnlTabla :messages"
                                             style="margin-top: 20px;"/>
                        </h:form>

                        <p:growl id="messages" showDetail="true" life="5000" sticky="false"/>
                    </div>
                </h:panelGroup>

                <!-- PANEL DETALLE -->
                <h:panelGroup id="pnlDetalle">
                    <h:form id="frmCrear" rendered="#{ventaFrm.estado != 'NADA'}">

                        <p:messages id="msgGlobal" showDetail="true" autoUpdate="true"/>

                        <h:panelGrid columns="2" cellpadding="5" style="width: 100%;">

                            <h:outputLabel for="txtIdPanel" value="#{msg['venta.campo.id']}:"/>
                            <h:panelGroup id="txtIdPanel">
                                <h:outputText rendered="#{empty ventaFrm.registro.id}"
                                              value="(#{msg['venta.id.autogenerado']})"/>
                                <h:inputText id="txtId"
                                             value="#{ventaFrm.registro.id}"
                                             rendered="#{not empty ventaFrm.registro.id}"
                                             disabled="true"
                                             styleClass="form-control-readonly"/>
                            </h:panelGroup>

                            <h:outputLabel for="selCliente" value="#{msg['venta.campo.cliente']}:*"/>
                            <p:selectOneMenu id="selCliente"
                                             value="#{ventaFrm.registro.idCliente.id}"
                                             converter="uuidConverter"
                                             required="true"
                                             requiredMessage="#{msg['mensaje.validacion.cliente.requerido']}"
                                             filter="true"
                                             filterMatchMode="contains"
                                             style="width: 100%;">
                                <f:selectItem itemLabel="-- Seleccione Cliente --"
                                              itemValue="#{null}"
                                              noSelectionOption="true" />
                                <f:selectItems value="#{ventaFrm.clientesDisponibles}"
                                               var="c"
                                               itemLabel="#{c.nombre} - #{c.dui}"
                                               itemValue="#{c.id}" />
                            </p:selectOneMenu>

                            <h:outputLabel for="txtFecha" value="#{msg['venta.campo.fecha']}:*"/>
                            <p:calendar id="txtFecha"
                                        value="#{ventaFrm.registro.fecha}"
                                        pattern="dd/MM/yyyy HH:mm"
                                        showTime="true"
                                        hourFormat="24"
                                        timeZone="America/El_Salvador"
                                        converter="offsetDateTimeConverter"
                                        required="true"
                                        requiredMessage="#{msg['mensaje.validacion.fecha.requerida']}"
                                        style="width: 100%;"/>

                            <h:outputLabel for="selEstado" value="#{msg['venta.campo.estado']}:*"/>
                            <p:selectOneMenu id="selEstado"
                                             value="#{ventaFrm.registro.estado}"
                                             required="true"
                                             requiredMessage="#{msg['mensaje.validacion.estado.requerido']}"
                                             style="width: 100%;">
                                <f:selectItem itemLabel="-- Seleccione Estado --"
                                              itemValue="#{null}"
                                              noSelectionOption="true" />
                                <f:selectItems value="#{ventaFrm.estadosDisponibles}"
                                               var="e"
                                               itemLabel="#{e}"
                                               itemValue="#{e}" />
                            </p:selectOneMenu>

                            <h:outputLabel for="txtObs" value="#{msg['venta.campo.observaciones']}:"/>
                            <p:inputTextarea id="txtObs"
                                             value="#{ventaFrm.registro.observaciones}"
                                             rows="4"
                                             style="width: 100%;"/>
                        </h:panelGrid>

                        <!-- Botones CRUD -->
                        <ui:include src="/paginas/ues/BotonesTop.xhtml">
                            <ui:param name="section" value="crud"/>
                            <ui:param name="bean" value="#{ventaFrm}"/>
                        </ui:include>

                        <!-- Botones para Cerrar y Anular Venta -->
                        <h:panelGroup rendered="#{ventaFrm.estado eq 'MODIFICAR'}"
                                      style="margin-top: 10px; display: flex; gap: 10px;">

                            <!-- Boton Cerrar/Finalizar Venta -->
                            <p:commandButton value="Finalizar Venta"
                                             icon="pi pi-check-circle"
                                             styleClass="ui-button-success"
                                             actionListener="#{ventaFrm.btnCerrarVentaHandler}"
                                             update=":pnlTabla :pnlDetalle :frmTabla:messages"
                                             disabled="#{ventaFrm.registro.estado eq 'FINALIZADA' or ventaFrm.registro.estado eq 'ANULADA'}">
                                <p:confirm header="Confirmación"
                                           message="¿Está seguro de finalizar esta venta?"
                                           icon="pi pi-exclamation-triangle"/>
                            </p:commandButton>

                            <!-- Boton Anular Venta -->
                            <p:commandButton value="Anular Venta"
                                             icon="pi pi-ban"
                                             styleClass="ui-button-danger"
                                             actionListener="#{ventaFrm.btnAnularVentaHandler}"
                                             update=":pnlTabla :pnlDetalle :frmTabla:messages"
                                             disabled="#{ventaFrm.registro.estado eq 'FINALIZADA' or ventaFrm.registro.estado eq 'ANULADA'}">
                                <p:confirm header="Confirmación"
                                           message="¿Está seguro de anular esta venta? Esta acción no se puede deshacer."
                                           icon="pi pi-exclamation-triangle"/>
                            </p:commandButton>
                        </h:panelGroup>
                    </h:form>

                    <!-- Botón Cancelar -->
                    <h:form id="frmCancelar">
                        <ui:include src="/paginas/ues/BotonesTop.xhtml">
                            <ui:param name="section" value="cancelar"/>
                            <ui:param name="bean" value="#{ventaFrm}"/>
                        </ui:include>
                    </h:form>
                </h:panelGroup>
            </div>
        </div>
    </div>

    <!-- Dialogo de confirmacion -->
    <p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
        <p:commandButton value="Si" type="button" styleClass="ui-confirmdialog-yes" icon="pi pi-check"/>
        <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no" icon="pi pi-times"/>
    </p:confirmDialog>

    <!-- WEBSOCKET: Conexion en tiempo real para actualizacion automatica -->
    <script type="text/javascript">
        //<![CDATA[
        var ws;
        var reconectarIntervalo = 3000;
        var intentosReconexion = 0;
        var maxIntentosReconexion = 5;

        function conectarWebSocket() {
            try {
                var protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                var host = window.location.host;
                var contextPath = '#{request.contextPath}';
                var wsUrl = protocol + '//' + host + contextPath + '/notificadorKardex';

                console.log('Conectando WebSocket a:', wsUrl);
                ws = new WebSocket(wsUrl);

                ws.onopen = function(event) {
                    console.log('WebSocket conectado exitosamente');
                    intentosReconexion = 0;
                };

                ws.onmessage = function(event) {
                    console.log('Mensaje WebSocket recibido:', event.data);
                    var mensaje = event.data;

                    // Detectar si es actualización de venta
                    if (mensaje.includes('VENTA') ||
                        mensaje.includes('reload-table') ||
                        mensaje.includes('RELOAD_TABLE')) {
                        console.log('Recargando tabla de ventas...');
                        recargarTabla();
                    }
                };

                ws.onerror = function(event) {
                    console.error('Error en WebSocket:', event);
                };

                ws.onclose = function(event) {
                    console.log('WebSocket desconectado. Codigo:', event.code);
                    if (intentosReconexion < maxIntentosReconexion) {
                        intentosReconexion++;
                        console.log('Intento de reconexion ' + intentosReconexion + '/' + maxIntentosReconexion);
                        setTimeout(conectarWebSocket, reconectarIntervalo);
                    }
                };

            } catch (error) {
                console.error('Error al crear WebSocket:', error);
            }
        }

        function recargarTabla() {
            try {
                if (typeof PrimeFaces !== 'undefined' && typeof PrimeFaces.ajax !== 'undefined') {
                    PrimeFaces.ajax.Request.handle({
                        source: 'frmTabla:tblVentas',
                        update: 'frmTabla:tblVentas frmTabla:messages',
                        process: '@none',
                        global: false,
                        async: true,
                        oncomplete: function(xhr, status, args) {
                            console.log('Tabla recargada');
                        }
                    });
                } else {
                    console.warn('PrimeFaces no disponible, recargando pagina');
                    setTimeout(function() { location.reload(); }, 1000);
                }
            } catch (error) {
                console.error('Error al recargar:', error);
            }
        }

        function cerrarWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                console.log('Cerrando WebSocket...');
                ws.close(1000, 'Usuario salió');
            }
        }

        // Conectar al cargar
        window.addEventListener('load', function() {
            console.log('Iniciando WebSocket...');
            setTimeout(conectarWebSocket, 500);
        });

        // Cerrar al salir
        window.addEventListener('beforeunload', cerrarWebSocket);

        // Reconectar si la pagina vuelve a estar visible
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && (!ws || ws.readyState !== WebSocket.OPEN)) {
                console.log('Reconectando...');
                conectarWebSocket();
            }
        });
        //]]>
    </script>
</h:body>
</html>