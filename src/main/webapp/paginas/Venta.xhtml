<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="jakarta.faces.html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:f="jakarta.faces.core">

<h:head>
    <meta charset="UTF-8"/>
    <h:outputStylesheet library="estilos" name="disenoAlmacen.css"/>
    <title>#{msg['venta.titulo.principal']}</title>
</h:head>

<h:body>
    <f:event type="preRenderView" listener="#{ventaFrm.inicializar}"/>

    <div class="page-container">
        <ui:include src="/paginas/ues/Sidebar.xhtml"/>
        <div class="container">
            <div class="header">
                <h1>#{msg['venta.titulo.principal']}</h1>
            </div>

            <div class="content">
                <!-- PANEL TABLA -->
                <h:panelGroup id="pnlTabla" layout="block"
                              style="display:#{ventaFrm.estado eq 'NADA' ? 'block' : 'none'}">
                    <div class="content-tabla">
                        <h:form id="frmTabla">
                            <p:dataTable id="tblVentas"
                                         lazy="true"
                                         rendered="#{ventaFrm.estado == 'NADA'}"
                                         rows="#{ventaFrm.pageSize}"
                                         paginator="true"
                                         paginatorPosition="bottom"
                                         value="#{ventaFrm.modelo}"
                                         var="item"
                                         selectionMode="single"
                                         selection="#{ventaFrm.registro}"
                                         rowKey="#{item.id}">

                                <p:ajax event="rowSelect"
                                        listener="#{ventaFrm.selectionHandler}"
                                        update=":pnlTabla :pnlDetalle :messages"/>

                                <p:column headerText="#{msg['tabla.venta.columna.id']}" width="200">
                                    <h:outputText value="#{item.id}"/>
                                </p:column>

                                <p:column headerText="#{msg['tabla.venta.columna.cliente']}">
                                    <h:outputText value="#{item.idCliente.nombre}"/>
                                </p:column>

                                <p:column headerText="#{msg['tabla.venta.columna.fecha']}">
                                    <h:outputText value="#{item.fecha}">
                                        <f:converter converterId="offsetDateTimeConverter"/>
                                    </h:outputText>
                                </p:column>

                                <p:column headerText="#{msg['tabla.venta.columna.estado']}" width="120">
                                    <h:outputText value="#{item.estado}"/>
                                </p:column>

                                <p:column headerText="#{msg['tabla.venta.columna.observaciones']}" width="200">
                                    <h:outputText value="#{item.observaciones}"/>
                                </p:column>
                            </p:dataTable>

                            <!-- BOTÓN NUEVO -->
                            <p:commandButton id="btnNuevo"
                                             value="#{msg['boton.nuevo']}"
                                             rendered="#{ventaFrm.estado == 'NADA' or ventaFrm.estado.name() == 'NADA'}"
                                             styleClass="btn-nuevo"
                                             actionListener="#{ventaFrm.btnNuevoHandler}"
                                             process="@this"
                                             update=":pnlDetalle :pnlTabla :messages"
                                             style="margin-top: 20px;"/>
                        </h:form>

                        <p:growl id="messages" showDetail="true" life="5000" sticky="false"/>
                    </div>
                </h:panelGroup>

                <!-- PANEL DETALLE -->
                <h:panelGroup id="pnlDetalle">
                    <h:form id="frmCrear" rendered="#{ventaFrm.estado != 'NADA'}">
                        <h:panelGrid columns="2" cellpadding="5" style="width: 100%;">

                            <h:outputLabel for="txtIdPanel" value="#{msg['venta.campo.id']}:"/>
                            <h:panelGroup id="txtIdPanel">
                                <h:outputText rendered="#{empty ventaFrm.registro.id}"
                                              value="(#{msg['venta.id.autogenerado']})"/>
                                <h:inputText id="txtId"
                                             value="#{ventaFrm.registro.id}"
                                             rendered="#{not empty ventaFrm.registro.id}"
                                             disabled="true"
                                             styleClass="form-control-readonly"/>
                            </h:panelGroup>

                            <h:outputLabel for="selCliente" value="#{msg['venta.campo.cliente']}:*"/>
                            <p:selectOneMenu id="selCliente"
                                             value="#{ventaFrm.registro.idCliente.id}"
                                             converter="uuidConverter"
                                             required="true"
                                             requiredMessage="#{msg['mensaje.validacion.cliente.requerido']}"
                                             filter="true"
                                             filterMatchMode="contains"
                                             style="width: 100%;">
                                <f:selectItem itemLabel="-- Seleccione Cliente --"
                                              itemValue="#{null}"
                                              noSelectionOption="true" />
                                <f:selectItems value="#{ventaFrm.clientesDisponibles}"
                                               var="c"
                                               itemLabel="#{c.nombre} - #{c.dui}"
                                               itemValue="#{c.id}" />
                            </p:selectOneMenu>

                            <h:outputLabel for="txtFecha" value="#{msg['venta.campo.fecha']}:*"/>
                            <p:calendar id="txtFecha"
                                        value="#{ventaFrm.registro.fecha}"
                                        pattern="dd/MM/yyyy HH:mm"
                                        showTime="true"
                                        hourFormat="24"
                                        timeZone="America/El_Salvador"
                                        converter="offsetDateTimeConverter"
                                        required="true"
                                        requiredMessage="#{msg['mensaje.validacion.fecha.requerida']}"
                                        style="width: 100%;"/>

                            <h:outputLabel for="selEstado" value="#{msg['venta.campo.estado']}:*"/>
                            <p:selectOneMenu id="selEstado"
                                             value="#{ventaFrm.registro.estado}"
                                             required="true"
                                             requiredMessage="#{msg['mensaje.validacion.estado.requerido']}"
                                             style="width: 100%;">
                                <f:selectItem itemLabel="-- Seleccione Estado --"
                                              itemValue="#{null}"
                                              noSelectionOption="true" />
                                <f:selectItems value="#{ventaFrm.estadosDisponibles}"
                                               var="e"
                                               itemLabel="#{e}"
                                               itemValue="#{e}" />
                            </p:selectOneMenu>

                            <h:outputLabel for="txtObs" value="#{msg['venta.campo.observaciones']}:"/>
                            <p:inputTextarea id="txtObs"
                                             value="#{ventaFrm.registro.observaciones}"
                                             rows="4"
                                             style="width: 100%;"/>
                        </h:panelGrid>

                        <!-- Botones Crear / Modificar / Eliminar -->
                        <h:panelGrid columns="1" style="margin-top: 15px;">
                            <ui:include src="/paginas/ues/BotonesTop.xhtml">
                                <ui:param name="section" value="crud"/>
                                <ui:param name="bean" value="#{ventaFrm}"/>
                            </ui:include>
                        </h:panelGrid>
                    </h:form>

                    <!-- Botón Cancelar: su propio form -->
                    <h:form id="frmCancelar">
                        <ui:include src="/paginas/ues/BotonesTop.xhtml">
                            <ui:param name="section" value="cancelar"/>
                            <ui:param name="bean" value="#{ventaFrm}"/>
                        </ui:include>
                    </h:form>
                </h:panelGroup>
            </div>
        </div>
    </div>
</h:body>
</html>